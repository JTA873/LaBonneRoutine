<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Réserver une séance - La Bonne Routine</title>
    <meta name="description" content="Réservez votre séance de coaching personnalisé en ligne">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    
    <style>
        /* Styles spécifiques à la page de réservation */
        .reserve-page {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
            padding-top: 100px;
        }

        .reserve-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .page-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .page-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: #111111;
            margin-bottom: 1rem;
            font-family: 'Playfair Display', serif;
        }

        .page-subtitle {
            font-size: 1.125rem;
            color: #6B7280;
            line-height: 1.6;
        }

        .booking-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }

        .service-selection {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #111111;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .service-card {
            border: 2px solid #E5E7EB;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .service-card:hover {
            border-color: #9E3728;
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(158, 55, 40, 0.1);
        }

        .service-card.selected {
            border-color: #9E3728;
            background: linear-gradient(135deg, rgba(158, 55, 40, 0.05), rgba(245, 158, 11, 0.05));
        }

        .service-card.selected::after {
            content: '✓';
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 24px;
            height: 24px;
            background: #9E3728;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.875rem;
        }

        .service-info {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .service-name {
            font-size: 1.125rem;
            font-weight: 600;
            color: #111111;
        }

        .service-price {
            font-size: 1.25rem;
            font-weight: 700;
            color: #9E3728;
        }

        .service-duration {
            color: #6B7280;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .service-description {
            color: #6B7280;
            font-size: 0.875rem;
            line-height: 1.5;
        }

        .calendar-container {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .calendar-nav-btn {
            background: #F3F4F6;
            border: none;
            border-radius: 12px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .calendar-nav-btn:hover {
            background: #9E3728;
            color: white;
        }

        .calendar-month {
            font-size: 1.25rem;
            font-weight: 600;
            color: #111111;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
            margin-bottom: 2rem;
        }

        .calendar-day-header {
            text-align: center;
            padding: 0.75rem 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: #6B7280;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            position: relative;
        }

        .calendar-day:hover {
            background: #F3F4F6;
        }

        .calendar-day.available {
            background: #F0FDF4;
            color: #059669;
        }

        .calendar-day.available:hover {
            background: #059669;
            color: white;
        }

        .calendar-day.selected {
            background: #9E3728;
            color: white;
        }

        .calendar-day.unavailable {
            color: #D1D5DB;
            cursor: not-allowed;
        }

        .time-slots {
            margin-top: 1.5rem;
        }

        .time-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.75rem;
        }

        .time-slot {
            padding: 0.75rem 1rem;
            border: 2px solid #E5E7EB;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .time-slot:hover {
            border-color: #9E3728;
            background: rgba(158, 55, 40, 0.05);
        }

        .time-slot.selected {
            border-color: #9E3728;
            background: #9E3728;
            color: white;
        }

        .time-slot.unavailable {
            color: #D1D5DB;
            border-color: #F3F4F6;
            cursor: not-allowed;
        }

        .booking-summary {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            margin-top: 2rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #F3F4F6;
        }

        .summary-item:last-child {
            border-bottom: none;
            font-weight: 600;
            font-size: 1.125rem;
            color: #9E3728;
        }

        .confirm-btn {
            width: 100%;
            background: linear-gradient(135deg, #9E3728, #7A2A1E);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 16px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 2rem;
            position: relative;
            overflow: hidden;
        }

        .confirm-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 35px rgba(158, 55, 40, 0.3);
        }

        .confirm-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .confirm-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .confirm-btn:hover::before {
            left: 100%;
        }

        .loading-spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .error-message {
            background: #FEE2E2;
            border: 1px solid #FECACA;
            color: #DC2626;
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            display: none;
        }

        .success-message {
            background: #D1FAE5;
            border: 1px solid #A7F3D0;
            color: #065F46;
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            display: none;
        }

        .auth-warning {
            background: #FEF3C7;
            border: 1px solid #FCD34D;
            color: #92400E;
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        /* Animation d'entrée */
        .service-selection,
        .calendar-container,
        .booking-summary {
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .booking-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .reserve-container {
                padding: 1rem;
            }

            .page-title {
                font-size: 2rem;
            }

            .calendar-grid {
                gap: 0.25rem;
            }

            .time-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <!-- Navigation simplifiée -->
    <nav class="navbar" style="position: fixed; top: 0; z-index: 1000;">
        <div class="nav-container">
            <div class="nav-brand">
                <img src="assets/logo.svg" alt="La Bonne Routine" class="logo">
                <span class="brand-text">La Bonne Routine</span>
            </div>
            
            <div class="nav-menu">
                <a href="index.html" class="nav-link">← Retour à l'accueil</a>
                <div class="nav-auth">
                    <a href="login.html" class="btn btn-outline" id="loginBtn">Connexion</a>
                    <a href="dashboard.html" class="btn btn-primary hidden" id="dashboardBtn">Mon compte</a>
                    <button class="btn btn-outline hidden" id="logoutBtn">Déconnexion</button>
                </div>
            </div>
        </div>
    </nav>

    <main class="reserve-page">
        <div class="reserve-container">
            <!-- En-tête de la page -->
            <div class="page-header">
                <h1 class="page-title">Réserver une séance</h1>
                <p class="page-subtitle">
                    Choisissez votre service et votre créneau pour commencer votre parcours de développement personnel
                </p>
            </div>

            <!-- Messages -->
            <div id="error-message" class="error-message"></div>
            <div id="success-message" class="success-message"></div>
            
            <!-- Avertissement d'authentification -->
            <div id="auth-warning" class="auth-warning" style="display: none;">
                ⚠️ Vous devez être connecté pour finaliser votre réservation
                <a href="login.html" style="color: inherit; font-weight: 600; text-decoration: underline;">Se connecter</a>
            </div>

            <div class="booking-grid">
                <!-- Sélection du service -->
                <div class="service-selection">
                    <h2 class="section-title">
                        🎯 Choisissez votre service
                    </h2>
                    
                    <div class="service-card" data-service="decouverte">
                        <div class="service-info">
                            <div class="service-name">Séance Découverte</div>
                            <div class="service-price">Gratuit</div>
                        </div>
                        <div class="service-duration">⏱️ 30 minutes</div>
                        <div class="service-description">
                            Première rencontre pour faire connaissance et définir vos objectifs personnels.
                        </div>
                    </div>

                    <div class="service-card" data-service="classique">
                        <div class="service-info">
                            <div class="service-name">Coaching Classique</div>
                            <div class="service-price">60€</div>
                        </div>
                        <div class="service-duration">⏱️ 1h30</div>
                        <div class="service-description">
                            Séance complète de coaching individuel avec plan d'action personnalisé.
                        </div>
                    </div>

                    <div class="service-card" data-service="developpement">
                        <div class="service-info">
                            <div class="service-name">Développement Personnel</div>
                            <div class="service-price">70€</div>
                        </div>
                        <div class="service-duration">⏱️ 1h15</div>
                        <div class="service-description">
                            Session approfondie de développement personnel et gestion des émotions.
                        </div>
                    </div>
                </div>

                <!-- Calendrier -->
                <div class="calendar-container">
                    <h2 class="section-title">
                        📅 Sélectionnez une date
                    </h2>
                    
                    <div class="calendar-header">
                        <button class="calendar-nav-btn" id="prevMonth">‹</button>
                        <div class="calendar-month" id="currentMonth"></div>
                        <button class="calendar-nav-btn" id="nextMonth">›</button>
                    </div>

                    <div class="calendar-grid" id="calendarGrid">
                        <div class="calendar-day-header">Lun</div>
                        <div class="calendar-day-header">Mar</div>
                        <div class="calendar-day-header">Mer</div>
                        <div class="calendar-day-header">Jeu</div>
                        <div class="calendar-day-header">Ven</div>
                        <div class="calendar-day-header">Sam</div>
                        <div class="calendar-day-header">Dim</div>
                    </div>

                    <div class="time-slots" id="timeSlots" style="display: none;">
                        <h3 style="margin-bottom: 1rem; color: #111111;">⏰ Créneaux disponibles</h3>
                        <div class="time-grid" id="timeGrid"></div>
                    </div>
                </div>
            </div>

            <!-- Résumé de réservation -->
            <div class="booking-summary" id="bookingSummary" style="display: none;">
                <h2 class="section-title">
                    📋 Résumé de votre réservation
                </h2>
                
                <div id="summaryContent">
                    <div class="summary-item">
                        <span>Service :</span>
                        <span id="summaryService">-</span>
                    </div>
                    <div class="summary-item">
                        <span>Date :</span>
                        <span id="summaryDate">-</span>
                    </div>
                    <div class="summary-item">
                        <span>Heure :</span>
                        <span id="summaryTime">-</span>
                    </div>
                    <div class="summary-item">
                        <span>Prix total :</span>
                        <span id="summaryPrice">-</span>
                    </div>
                </div>

                <button class="confirm-btn" id="confirmBooking" disabled>
                    <span class="loading-spinner" id="loadingSpinner"></span>
                    <span id="confirmText">Confirmer la réservation</span>
                </button>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script type="module" src="js/firebase-init.js"></script>
    <script type="module" src="js/auth.js"></script>
    <script type="module">
        import { auth } from './js/firebase-init.js';
        import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';

        // État de la réservation
        let selectedService = null;
        let selectedDate = null;
        let selectedTime = null;
        let currentUser = null;
        let currentMonth = new Date();

        // Services disponibles
        const services = {
            decouverte: { name: 'Séance Découverte', price: 0, duration: 30 },
            classique: { name: 'Coaching Classique', price: 60, duration: 90 },
            developpement: { name: 'Développement Personnel', price: 70, duration: 75 }
        };

        // Créneaux horaires disponibles
        const availableSlots = [
            '09:00', '10:30', '14:00', '15:30', '17:00'
        ];

        // Éléments DOM
        const serviceCards = document.querySelectorAll('.service-card');
        const calendarGrid = document.getElementById('calendarGrid');
        const currentMonthEl = document.getElementById('currentMonth');
        const prevMonthBtn = document.getElementById('prevMonth');
        const nextMonthBtn = document.getElementById('nextMonth');
        const timeSlotsEl = document.getElementById('timeSlots');
        const timeGridEl = document.getElementById('timeGrid');
        const bookingSummary = document.getElementById('bookingSummary');
        const confirmBtn = document.getElementById('confirmBooking');
        const authWarning = document.getElementById('auth-warning');
        const errorMessage = document.getElementById('error-message');
        const successMessage = document.getElementById('success-message');

        // Initialisation
        document.addEventListener('DOMContentLoaded', () => {
            initializeServiceSelection();
            initializeCalendar();
            updateCalendar();
            
            // Vérifier les paramètres URL
            const urlParams = new URLSearchParams(window.location.search);
            const serviceType = urlParams.get('type');
            if (serviceType && services[serviceType]) {
                selectService(serviceType);
            }
        });

        // Gestion de l'authentification
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            updateAuthDisplay();
        });

        function updateAuthDisplay() {
            const loginBtn = document.getElementById('loginBtn');
            const dashboardBtn = document.getElementById('dashboardBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            
            if (currentUser) {
                loginBtn.classList.add('hidden');
                dashboardBtn.classList.remove('hidden');
                logoutBtn.classList.remove('hidden');
                authWarning.style.display = 'none';
            } else {
                loginBtn.classList.remove('hidden');
                dashboardBtn.classList.add('hidden');
                logoutBtn.classList.add('hidden');
                if (selectedService && selectedDate && selectedTime) {
                    authWarning.style.display = 'flex';
                }
            }
        }

        // Sélection de service
        function initializeServiceSelection() {
            serviceCards.forEach(card => {
                card.addEventListener('click', () => {
                    const service = card.dataset.service;
                    selectService(service);
                });
            });
        }

        function selectService(service) {
            selectedService = service;
            
            // Mettre à jour l'affichage
            serviceCards.forEach(card => {
                card.classList.toggle('selected', card.dataset.service === service);
            });
            
            updateSummary();
        }

        // Gestion du calendrier
        function initializeCalendar() {
            prevMonthBtn.addEventListener('click', () => {
                currentMonth.setMonth(currentMonth.getMonth() - 1);
                updateCalendar();
            });

            nextMonthBtn.addEventListener('click', () => {
                currentMonth.setMonth(currentMonth.getMonth() + 1);
                updateCalendar();
            });
        }

        function updateCalendar() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            
            // Mettre à jour le titre du mois
            currentMonthEl.textContent = new Intl.DateTimeFormat('fr-FR', {
                month: 'long',
                year: 'numeric'
            }).format(currentMonth);

            // Générer le calendrier
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - ((firstDay.getDay() + 6) % 7));

            // Nettoyer la grille
            const dayElements = calendarGrid.querySelectorAll('.calendar-day');
            dayElements.forEach(el => el.remove());

            // Générer les jours
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const dayEl = document.createElement('div');
                dayEl.classList.add('calendar-day');
                dayEl.textContent = date.getDate();
                
                const isCurrentMonth = date.getMonth() === month;
                const isFuture = date >= today;
                const isWeekday = date.getDay() >= 1 && date.getDay() <= 5; // Lun-Ven
                
                if (isCurrentMonth && isFuture && isWeekday) {
                    dayEl.classList.add('available');
                    dayEl.addEventListener('click', () => selectDate(date));
                } else {
                    dayEl.classList.add('unavailable');
                }
                
                calendarGrid.appendChild(dayEl);
            }
        }

        function selectDate(date) {
            selectedDate = date;
            selectedTime = null;
            
            // Mettre à jour l'affichage
            document.querySelectorAll('.calendar-day').forEach(day => {
                day.classList.remove('selected');
            });
            
            event.target.classList.add('selected');
            
            // Afficher les créneaux horaires
            showTimeSlots();
            updateSummary();
        }

        function showTimeSlots() {
            timeSlotsEl.style.display = 'block';
            timeGridEl.innerHTML = '';
            
            availableSlots.forEach(time => {
                const timeEl = document.createElement('div');
                timeEl.classList.add('time-slot');
                timeEl.textContent = time;
                timeEl.addEventListener('click', () => selectTime(time, timeEl));
                timeGridEl.appendChild(timeEl);
            });
        }

        function selectTime(time, element) {
            selectedTime = time;
            
            // Mettre à jour l'affichage
            document.querySelectorAll('.time-slot').forEach(slot => {
                slot.classList.remove('selected');
            });
            
            element.classList.add('selected');
            updateSummary();
        }

        // Mise à jour du résumé
        function updateSummary() {
            if (selectedService && selectedDate && selectedTime) {
                bookingSummary.style.display = 'block';
                
                const service = services[selectedService];
                document.getElementById('summaryService').textContent = service.name;
                document.getElementById('summaryDate').textContent = selectedDate.toLocaleDateString('fr-FR');
                document.getElementById('summaryTime').textContent = selectedTime;
                document.getElementById('summaryPrice').textContent = service.price === 0 ? 'Gratuit' : `${service.price}€`;
                
                confirmBtn.disabled = false;
                
                // Vérifier l'authentification
                updateAuthDisplay();
            } else {
                bookingSummary.style.display = 'none';
            }
        }

        // Confirmation de réservation
        confirmBtn.addEventListener('click', async () => {
            if (!currentUser) {
                showMessage('Vous devez être connecté pour réserver', 'error');
                return;
            }

            if (!selectedService || !selectedDate || !selectedTime) {
                showMessage('Veuillez sélectionner un service, une date et un créneau', 'error');
                return;
            }

            setLoading(true);

            try {
                // Simuler l'envoi de la réservation
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                showMessage('Réservation confirmée ! Vous recevrez un email de confirmation.', 'success');
                
                // Reset du formulaire
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 3000);
                
            } catch (error) {
                console.error('Erreur lors de la réservation:', error);
                showMessage('Erreur lors de la réservation. Veuillez réessayer.', 'error');
                setLoading(false);
            }
        });

        // Fonctions utilitaires
        function setLoading(loading) {
            const spinner = document.getElementById('loadingSpinner');
            const text = document.getElementById('confirmText');
            
            if (loading) {
                spinner.style.display = 'inline-block';
                text.textContent = 'Confirmation en cours...';
                confirmBtn.disabled = true;
            } else {
                spinner.style.display = 'none';
                text.textContent = 'Confirmer la réservation';
                confirmBtn.disabled = false;
            }
        }

        function showMessage(message, type = 'error') {
            hideMessages();
            const messageEl = type === 'error' ? errorMessage : successMessage;
            messageEl.textContent = message;
            messageEl.style.display = 'block';
            
            // Auto-hide après 5 secondes
            setTimeout(hideMessages, 5000);
        }

        function hideMessages() {
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
        }
    </script>
</body>
</html>
